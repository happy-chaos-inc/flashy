<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="%PUBLIC_URL%/logo.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <!-- Prevent caching to ensure users get updates -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://*.supabase.co wss://*.supabase.co https://api.openai.com https://api.anthropic.com; img-src 'self' data: blob:;"
    />
    <meta
      name="description"
      content="Flashy - Collaborative markdown study notes with real-time flashcards"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo.svg" />
    <!--
      manifest.json provides metadata used when your web app is installed on a
      user's mobile device or desktop. See https://developers.google.com/web/fundamentals/web-app-manifest/
    -->
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <!--
      Notice the use of %PUBLIC_URL% in the tags above.
      It will be replaced with the URL of the `public` folder during the build.
      Only files inside the `public` folder can be referenced from the HTML.

      Unlike "/favicon.ico" or "favicon.ico", "%PUBLIC_URL%/favicon.ico" will
      work correctly both with client-side routing and a non-root public URL.
      Learn how to configure a non-root public URL by running `npm run build`.
    -->
    <title>Flashy</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>

    <!-- GitHub Pages SPA redirect handler -->
    <script type="text/javascript">
      // Handle redirect from 404.html for SPA routing on GitHub Pages
      (function(l) {
        if (l.search[1] === '/' ) {
          var decoded = l.search.slice(1).split('&').map(function(s) {
            return s.replace(/~and~/g, '&')
          }).join('?');
          window.history.replaceState(null, null,
              l.pathname.slice(0, -1) + decoded + l.hash
          );
        }
      }(window.location))
    </script>

    <!-- Stale code detection: fetch latest index.html from server, compare bundle hash -->
    <script>
      (async function() {
        // Prevent infinite reload: allow max 1 reload within 10 seconds
        var lastReload = parseInt(sessionStorage.getItem('flashy_last_reload') || '0');
        if (Date.now() - lastReload < 10000) return;

        try {
          // Fetch the CURRENT index.html this browser is rendering
          // (This page — the HTML we're in right now — may itself be cached)
          var thisHtml = document.documentElement.outerHTML;
          var thisMatch = thisHtml.match(/main\.([a-f0-9]+)\.js/);

          // Fetch fresh index.html from server (bypass all caches)
          var response = await fetch(window.location.pathname + '?_=' + Date.now(), {
            cache: 'no-store'
          });
          var serverHtml = await response.text();
          var serverMatch = serverHtml.match(/main\.([a-f0-9]+)\.js/);

          if (!thisMatch || !serverMatch) return;

          if (thisMatch[1] !== serverMatch[1]) {
            console.log('[Flashy] New version available:', thisMatch[1], '->', serverMatch[1]);
            sessionStorage.setItem('flashy_last_reload', Date.now().toString());

            // Clear IndexedDB
            if ('indexedDB' in window && typeof indexedDB.databases === 'function') {
              var dbs = await indexedDB.databases();
              for (var i = 0; i < dbs.length; i++) {
                if (dbs[i].name) indexedDB.deleteDatabase(dbs[i].name);
              }
            }

            // Clear HTTP caches
            if ('caches' in window) {
              var names = await caches.keys();
              await Promise.all(names.map(function(n) { return caches.delete(n); }));
            }

            window.location.reload(true);
          }
        } catch (e) {
          // Network error — continue with current code
        }
      })();
    </script>

    <div id="root"></div>
    <!--
      This HTML file is a template.
      If you open it directly in the browser, you will see an empty page.

      You can add webfonts, meta tags, or analytics to this file.
      The build step will place the bundled scripts into the <body> tag.

      To begin the development, run `npm start` or `yarn start`.
      To create a production bundle, use `npm run build` or `yarn build`.
    -->
  </body>
</html>
